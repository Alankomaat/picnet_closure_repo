<!doctype html>
<html>
  <head></head>
  <body>
    <script src="http://localhost/shared/closure-library/closure/goog/base.js"></script>
    <script src="../deps.js"></script>
    <script>
goog.require('goog.testing.jsunit');

goog.require('pn.model.Collection');
goog.require('pn.model.EventType');
goog.require('pn.model.TimerInstance');
goog.require('goog.events');
goog.require('goog.date.Date');

var arr,
    collection,
    changes,
    counter = 0;

var setUp = function() {
  pn.model.TimerInstance.startTimer_ = function() {};

  arr = [createObj(1), createObj(2), createObj(3)];
  collection = new pn.model.Collection(arr);  
  goog.events.listen(collection, pn.model.EventType.CHANGE, function(e) {
    changes = e.changes;
  });
  assertEquals(changes, undefined);
};

var createObj = function(id) {
  id = id + (++counter);
  return { 'ID': id, 'Name': 'Name Value', 'Num': 1,
    'Date': new goog.date.Date(2000, 0, 1), 'ObjRef': {}, 
    'ObjEquality': {
      'Val': 1,
      clone: function() { return {'Val' : this['Val']}; },
      equals: function(other) { return this['Val'] == other['Val']; }
    },
  };
};

var checkForChanges_ = function() {
  changes = undefined;
  pn.model.TimerInstance.checkForChanges_();  
};

var tearDown = function() {
  goog.dispose(collection);
  changes = undefined;
};

var test_collection_change_event_on_basic_changes_on_all_indexes_of_arr = function () {        
  var idxTest = function(idx) {    
    arr[idx]['Name'] = 'New Name';    
    checkForChanges_();  
    assertEquals(1, changes.length);
    var change = changes[0];
    assertEquals(1, change.changes.length);

    change = change.changes[0];
    assertEquals('Name', change.field);
    assertEquals('Name Value', change.oldval);
    assertEquals('New Name', change.newval);  
  };

  idxTest(0);  
  idxTest(1);
  idxTest(2);
};

var test_collection_change_event_on_add = function() {
  var added = createObj('added');
  arr.push(added);

  checkForChanges_();  
  assertEquals(1, changes.length);

  var change = changes[0];
  assertTrue(change.inserted);
  assertEquals(added['ID'], change.item['ID']);
};

var test_collection_change_event_on_delete_in_middle = function() {
  var id = arr[1]['ID'];
  delete arr[1];
  checkForChanges_();  

  assertEquals(1, changes.length);

  var change = changes[0];
  assertTrue(change.removed);
  assertEquals(id, change.item['ID']);
};

var test_collection_change_event_on_delete_in_start = function() {
  var deleted = arr[0];
  delete arr[0];
  checkForChanges_();  
  assertEquals(1, changes.length);

  var change = changes[0];
  assertTrue(change.removed);
  assertEquals(deleted['ID'], change.item['ID']);
};

var test_collection_change_event_on_delete_in_end = function() {
  var deleted = arr[2];
  delete arr[2];
  checkForChanges_();  
  assertEquals(1, changes.length);

  var change = changes[0];
  assertTrue(change.removed);
  assertEquals(deleted['ID'], change.item['ID']);
};

var test_collection_change_event_on_remove = function() {
  var removed = arr[1];
  arr.splice(1, 1);
  checkForChanges_();  
  assertEquals(1, changes.length);
  
  var change = changes[0];
  assertTrue(change.removed);
  assertEquals(removed['ID'], change.item['ID']);
};

var test_collection_change_event_on_insert = function() {
  var inserted = createObj('inserted');
  arr.splice(1, 0, inserted);
  checkForChanges_();  
  assertEquals(1, changes.length);

  var change = changes[0];
  assertTrue(change.inserted);
  assertEquals(inserted['ID'], change.item['ID']);  
};

var test_adding_multiple = function() {
  var added1 = createObj('added1');
  var added2 = createObj('added2');
  arr.push(added1);
  arr.push(added2);
  checkForChanges_();  
  assertEquals(2, changes.length);

  var change = changes[0];
  assertTrue(change.inserted);
  assertEquals(added1['ID'], change.item['ID']);

  change = changes[1];
  assertTrue(change.inserted);
  assertEquals(added2['ID'], change.item['ID']);
};

var test_deleting_multiple = function() {
  var deleting1 = arr[0];
  var deleting2 = arr[2];
  delete arr[0];
  delete arr[2];
  checkForChanges_();  
  assertEquals(2, changes.length);

  var change = changes[0];
  assertTrue(change.removed);
  assertEquals(deleting1['ID'], change.item['ID']);

  change = changes[1];
  assertTrue(change.removed);
  assertEquals(deleting2['ID'], change.item['ID']);
};

var test_insert_multiple_fires_correct_details = function() {
  var inserted1 = createObj('inserted1');
  var inserted2 = createObj('inserted2');
  arr.splice(1, 0, inserted1, inserted2);

  checkForChanges_();  
  assertEquals(2, changes.length);

  var change = changes[0];
  assertTrue(change.inserted);
  assertEquals(inserted1['ID'], change.item['ID']);

  change = changes[1];
  assertTrue(change.inserted);
  assertEquals(inserted2['ID'], change.item['ID']);
};

var test_remove_multiple_fires_correct_details = function() {
  var remove1 = arr[0];
  var remove2 = arr[1];
  arr.splice(0, 2);
  checkForChanges_();  
  assertEquals(2, changes.length);

  change = changes[0];
  assertTrue(change.removed);
  assertEquals(remove1['ID'], change.item['ID']);

  change = changes[1];
  assertTrue(change.removed);
  assertEquals(remove2['ID'], change.item['ID']);
};

var test_sorting_or_reversing_is_ignored = function() {  
  arr.reverse();  
  checkForChanges_();  
  assertEquals(undefined, changes);
};

var test_changes_do_not_get_fired_multiple_times = function() {  
  arr.push(createObj('added'));

  checkForChanges_();  
  assertEquals(1, changes.length);  

  checkForChanges_();  
  assertEquals(undefined, changes);  
};

var test_multiple_updates_to_the_list = function() {
  test_adding_multiple();
  test_adding_multiple();
  test_collection_change_event_on_delete_in_middle();
  test_collection_change_event_on_add();  
};
    </script>    
  </body>
</html>

