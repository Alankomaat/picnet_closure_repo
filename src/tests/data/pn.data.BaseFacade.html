<!doctype html>
<html>
    <head></head>
    <body>
        <script src="http://localhost/shared/closure-library/closure/goog/base.js"></script>
        <script src="../../deps.js"></script>
        <script>        
goog.require('goog.testing.jsunit');        
        </script>
        <script>

goog.require('pn.data.BaseFacade');
goog.require('pn.data.Entity');
goog.require('pn.testing.MockServer');

var facade,
    server,
    events,
    xhrs;

var setUp = function() {
  xhrs = [];
  events = [];
  goog.global.setInterval = function() {};
  facade = new pn.data.BaseFacade('controller_uri');  
  facade.cache.cache_['EntityType'] = [];
  facade.server = (server = new pn.testing.MockServer());
  
  pn.data.TypeRegister.parseEntity = function(type, raw) {
    var entity = new pn.data.Entity(type, raw.ID);
    goog.object.extend(entity, raw);
    delete entity.ID;
    return entity;
  };
};

////////////////////////////////////////////////////////////////////////////////
// BaseFacade.getEntity
////////////////////////////////////////////////////////////////////////////////

var testGetEntityThrowsErrorIfTypeNotInCache = function() {
  try { 
    facade.getEntity('UnknownType', 1); 
    assertFails('Expected failure with UnknownType');
  }
  catch (ex) {};  
  validateServerCalls([]);
};

var testGetEntityThrowsErrorIfIDNotInCache = function() {  
  try { 
    facade.getEntity('EntityType', 11); 
    assertFails('Expected failure with invalid ID');
  }
  catch (ex) {};  
  validateServerCalls([]);
};

var testGetEntityReturnsEntityInCache = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  var created = facade.createEntity(entity);
  assertTrue(entity.equals(facade.getEntity('EntityType', created.id)));
  
  validateServerCalls([{method:'createEntity', entity:created}]); 
};

////////////////////////////////////////////////////////////////////////////////
// BaseFacade.createEntity
////////////////////////////////////////////////////////////////////////////////

var testCreateEntityCreatesInCacheFirstWithNegativeID = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  server.createEntity = function() {}; // Dissable the server call
  var created = facade.createEntity(entity);
  
  assertTrue(created.id < 0);
  assertArrayEquals([created], facade.cache.query(['EntityType'])['EntityType']);  
  validateServerCalls([]); 
};

var testCreateEntityUpdatesServerAndThenUpdatesLocalID = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  var created = facade.createEntity(entity);
  
  validateServerCalls([{method:'createEntity', entity:created}]); 
  assertTrue(created.id > 0);  
  assertArrayEquals([created], facade.cache.query(['EntityType'])['EntityType']);
};

var testCreateEntityWithErrorRemovesEntityFromTheLocalCache = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  server.nextFail = true;
  
  try { facade.createEntity(entity); assertFail('1'); } 
  catch(ex) {};
    
  validateServerCalls([{method:'createEntity', entity: entity}]);   
  var list = facade.cache.query(['EntityType'])['EntityType']; 
  assertArrayEquals([], list);
};

////////////////////////////////////////////////////////////////////////////////
// BaseFacade.updateEntity
////////////////////////////////////////////////////////////////////////////////

var testUpdateEntityUpdatesInCacheFirst = function() {  
  server.updateEntity = function() {}; // Dissable the server call
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  facade.updateEntity(entity2);
  
  assertEquals(1, entity2.id);
  assertArrayEquals([entity2], facade.cache.query(['EntityType'])['EntityType']);  
  validateServerCalls([]); 
};

var testUpdateEntityUpdatesCacheThenServer = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  facade.updateEntity(entity2);
  
  assertTrue(entity2.id > 0);  
  validateServerCalls([{method:'updateEntity', entity:entity2}]); 
};

var testUpdateEntityWithErrorUndoesLocalChange = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  
  var before = entity2.clone();
  var after = entity2.clone();
  
  after.newpropery = 'newproperty';
  server.nextFail = true;  

  try { facade.updateEntity(after); assertFail('1'); } 
  catch(ex) {};
    
  validateServerCalls([{method:'updateEntity', entity:after}]); 
  
  var list = facade.cache.query(['EntityType'])['EntityType']; 
  assertArrayEquals([before], list);
};

////////////////////////////////////////////////////////////////////////////////
// BaseFacade.deleteEntity
////////////////////////////////////////////////////////////////////////////////

var testDeleteEntityDeletesInCacheFirst = function() {  
  server.deleteEntity = function() {}; // Dissable the server call
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);

  facade.deleteEntity(entity2);
  
  assertArrayEquals([], facade.cache.query(['EntityType'])['EntityType']);  
  validateServerCalls([]); 
};

var testDeleteEntityDeletesCacheThenServer = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  facade.deleteEntity(entity2);
  
  assertArrayEquals([], facade.cache.query(['EntityType'])['EntityType']);
  validateServerCalls([{method:'deleteEntity', entity:entity2}]);  
};

var testDeleteEntityWithErrorUndoesLocalChange = function() {
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  
  server.nextFail = true;  
  try { facade.deleteEntity(entity2); assertFail('1'); } 
  catch(ex) {};
    
  validateServerCalls([{method:'deleteEntity', entity:entity2}]);  
  var list = facade.cache.query(['EntityType'])['EntityType']; 
  assertArrayEquals([entity2], list);
};

////////////////////////////////////////////////////////////////////////////////
// BaseFacade.query
////////////////////////////////////////////////////////////////////////////////

var testQueryDoesNotTouchServer = function() {
  var list = [];
  facade.query(['EntityType'], function(list2) { list = list2; });
      
  validateServerCalls([]);  
  assertArrayEquals([], list['EntityType']);
};

var testQueryDoesNotTouchServerWithFailure = function() {
  server.nextFail = true;  
  testQueryDoesNotTouchServer();
};

////////////////////////////////////////////////////////////////////////////////
// BaseFacade.ajax
////////////////////////////////////////////////////////////////////////////////

var testAjaxGoesStraightToTheServer = function() {
  var exp = { name:'name' };
  server.nextAjaxResponseData = exp;
  var args = {arg:1};
  var actual;
  facade.ajax('Controller', 'Action', args, function(resp) {
    actual = resp;
  });
  assertEquals(args, server.lastAjaxArgData);
  assertEquals(exp, actual);
};

////////////////////////////////////////////////////////////////////////////////
// Response Objects
////////////////////////////////////////////////////////////////////////////////
var testAjaxResponse = function() {
  prepareServerReponse();
  testAjaxGoesStraightToTheServer();
  validateResponseDetails();
};

var testCreateEntityResponse = function() {
  prepareServerReponse();
  var entity = new pn.data.Entity('EntityType', 0);
  var created = facade.createEntity(entity);
  validateResponseDetails([created]);
};

var testUpdateEntityResponse = function() {
  prepareServerReponse();
  
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  facade.updateEntity(entity2);

  validateResponseDetails([entity2]);
};

var testDeleteEntityResponse = function() {
  prepareServerReponse();
  
  var entity = new pn.data.Entity('EntityType', 0);
  var entity2 = facade.cache.createEntity(entity).clone();
  var tmpid = entity2.id;
  entity2.id = 1;
  facade.cache.updateEntity(entity2, tmpid);
  facade.deleteEntity(entity2);

  validateResponseDetails();
};

var testSyncResponseDetails = function() {
  prepareServerReponse();

  facade.sync_();

  validateResponseDetails();
};


var validateServerCalls = function(exp) {
  assertEquals(exp.length, server.calls.length);
  goog.array.forEach(exp, function(e, i) {
    assertEquals(e.method, server.calls[i].method);
    if (e.entity) {
      var actual = goog.array.find(server.calls[i].args, function(a) {
        return a instanceof pn.data.Entity;
      });
      assertTrue(e.entity.equals(actual));
    }
  });
};

var prepareServerReponse = function() {
  var updates = [
    { Type:'create', ID:100, EntityType: 'EntityType', Entity: { ID:100 } },
    { Type:'create', ID:101, EntityType: 'EntityType', Entity: { ID:101 } },
    { Type:'update', ID:100, EntityType: 'EntityType', Entity: { ID:100, NewProp:'NewProp' } },
    { Type:'delete', ID:101, EntityType: 'EntityType' }
  ];
  server.nextServerResponseUpdates = updates;  
};

var validateResponseDetails = function(opt_additional) {
  var list = facade.cache.query(['EntityType'])['EntityType'];  
  var entity = new pn.data.Entity('EntityType', 100);
  entity.NewProp = 'NewProp';
  var exp = opt_additional ? opt_additional : [];
  exp.push(entity);
  assertArrayEquals(exp, list);
};

        </script>
    </body>
</html>