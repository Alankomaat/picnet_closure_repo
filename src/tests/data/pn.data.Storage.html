<!doctype html>
<html>
    <head>
      <meta http-equiv="cache-control" content="max-age=0" />
      <meta http-equiv="cache-control" content="no-cache" />
      <meta http-equiv="expires" content="0" />
      <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
      <meta http-equiv="pragma" content="no-cache" />
      
      <script src="../../../lib/lawnchair-0.6.1.min.js"></script>
      <script src="../../../lib/lawnchair-memory.min.js"></script>
      <script src="../../../lib/lawnchair-webkit-sqlite.min.js"></script>

    </head>
    <body>
        <script src="http://localhost/shared/closure-library/closure/goog/base.js"></script>
        <script src="../../deps.js"></script>
        <script>        
goog.require('goog.testing.jsunit');
goog.require('goog.testing.AsyncTestCase');
        </script>
        <script>

goog.require('pn');
goog.require('pn.data.Storage');
goog.require('pn.data.Storage.Type');
goog.require('pn.json');

var prefix = 'test_storage_',
    ls = window.localStorage,
    store;

var tearDown = function() {
  if (!!store) {
    tc.waitForAsync();    
    store.nuke(tc.continueTesting.pnbind(tc));
  }
  var ls = window.localStorage;
  goog.object.getKeys(ls).pnforEach(function(k) {
    if (goog.string.startsWith(k, prefix)) { delete localStorage[k]; }
  });
};

var test_memory_db_only_uses_mem = function() {  
  tc.waitForAsync(); 
  store = new pn.data.Storage('db', function(store) {
    assertEquals(pn.data.Storage.Type.memory, store.adapter);
    tc.continueTesting();
  }, pn.data.Storage.Type.memory);  
};

var test_localStorage_db_uses_localStorage = function() {
  tc.waitForAsync(); 
  store = new pn.data.Storage('db', function(store) {
    assertEquals(pn.data.Storage.Type.localStorage, store.adapter);
    tc.continueTesting();
  }, pn.data.Storage.Type.localStorage);  
};

var test_websql_db_uses_websql = function() {
  tc.waitForAsync(); 
  store = new pn.data.Storage('db', function(store) {
    assertEquals(pn.data.Storage.Type.websql, store.adapter);
    tc.continueTesting();
  }, pn.data.Storage.Type.websql);  
};

var test_indexeddb_not_supported = function() {
  tc.waitForAsync(); 
  var gotex = false;
  try {
    store = new pn.data.Storage('db', function() { fail('Not supported'); }, pn.data.Storage.Type.indexeddb);  
  } catch (ex) { gotex = true; assertEquals('No valid adapter.', ex); } 
  finally { tc.continueTesting(); }
  assertTrue(gotex);
};

var test_multiple_stores_on_local_storage_is_responsible = function() {
  tc.waitForAsync();
  var key1 = prefix + 'db1',
      key2 = prefix + 'db2';
  new pn.data.Storage(key1, function(store1) {    
    new pn.data.Storage(key2, function(store2) {
      store1.save({k1:1}, function() {
        store1.save({k12:12}, function() {
          store2.save({k2:2}, function() {
            store2.save({k22:22}, function() {
              assertTrue(goog.isString(ls[key1 + '._index_']));
              assertTrue(goog.isString(ls[key2 + '._index_']));
              assertEquals(2, pn.json.parseJson(ls[key1 + '._index_']).length);
              assertEquals(2, pn.json.parseJson(ls[key2 + '._index_']).length);
              tc.continueTesting();
            });      
          });      
        });      
      });      
    }, pn.data.Storage.Type.localStorage);  
  }, pn.data.Storage.Type.localStorage);  
};

var tc = goog.testing.AsyncTestCase.createAndInstall();
        </script>
    </body>
</html>